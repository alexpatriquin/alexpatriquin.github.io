<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[SquareCraft]]></title>
  <link href="http://alexpatriquin.github.io/atom.xml" rel="self"/>
  <link href="http://alexpatriquin.github.io/"/>
  <updated>2014-05-05T00:31:14-04:00</updated>
  <id>http://alexpatriquin.github.io/</id>
  <author>
    <name><![CDATA[Alex Patriquin]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Twilio Text-To-Speech in Rails 4]]></title>
    <link href="http://alexpatriquin.github.io/twilio-text-to-speech-in-rails-4"/>
    <updated>2014-05-04T15:06:41-04:00</updated>
    <id>http://alexpatriquin.github.io/twilio-text-to-speech-in-rails-4</id>
    <content type="html"><![CDATA[<p>This post walks through the steps I took to set up text-to-speech in a Rails 4 app. To learn about other options for implementing text-to-speech in web apps generally, see <a href="http://alexpatriquin.github.io/text-to-speech-options-for-web-apps">Text-To-Speech Options for Web Apps</a>.</p>

<p>Also, the Twilio blog has a tutorial worth reading, <a href="https://www.twilio.com/blog/2014/02/twilio-on-rails-integrating-twilio-with-your-rails-4-app.html">Integrating Twilio With Your Rails 4 App</a>, but it does not cover setting up the crucial <a href="https://www.twilio.com/docs/client/device">Twilio.Device</a> or TTS in Rails 4.</p>

<p>Before we get started, note that Twilio.Device only works when connected to the internet. So you can’t test Twilio.Device from localhost. Instead, you’ll need to expose your localhost to the internet with a utility called ngrok. (See <a href="#ngrok">below</a>.)</p>

<p>In order to set up Twilio TTS in a Rails 4 app, we need to complete 10 steps.</p>

<ol>
<li>Sign up for Twilio</li>
<li>Install the twilio-ruby gem</li>
<li>Add endpoint for Twilio</li>
<li>Disable DSRF Detection on Twilio endpoint</li>
<li>Create a TwiML App</li>
<li>Setup Capability Tokens</li>
<li>Put Capability Token and text in an HTML form</li>
<li>Add Twilio.Device javascript</li>
<li>Setup ngrok to test</li>
<li>Deploy</li>
</ol>


<!-- more -->


<p>For this walkthrough, I&rsquo;ll refer to code examples from <a href="http://www.poemtoday.com/">PoemToday</a>, a Rails 4 app that generates random poems from user input and reads them aloud. Let&rsquo;s begin.</p>

<h3>1) Sign up for Twilio</h3>

<p>Easy enough. You’ll need an Account <code>SID</code> (short for “security identifier”) and <code>Auth Token</code>. Remember to hide these keys in <code>secrets.yml</code> if you’re pushing up to a public repo.</p>

<h3>2) Install the twilio-ruby gem</h3>

<p>Twilio provides an <a href="https://github.com/twilio/twilio-ruby">official ruby wrapper</a>. We’ll use the DSL from the gem to create TWiML, or Twilio XML, and to create Capability Tokens.</p>

<h3>3) Add endpoints for Twilio</h3>

<p>We’re going to create a POST endpoint for Twilio to tap into our app and receive the text we want read aloud. To do this in PoemToday, I added a <code>voice</code> action on my poems controller.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>post 'poems/voice' => 'poems#voice'</span></code></pre></td></tr></table></div></figure>


<p>Then, within the PoemsController, I setup the <code>voice</code> action to build a Twilio Response Object with the text we want spoken (sent as <code>params</code>). The method utilizes Twilio&rsquo;s <a href="https://www.twilio.com/docs/api/twiml/say">Say</a> verb and renders the <code>response</code> as TwiML.</p>

<figure class='code'><figcaption><span>Twilio Endpoint Example</span><a href='https://github.com/alexpatriquin/poem-today/blob/master/app/controllers/poems_controller.rb'>source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PoemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">after_filter</span> <span class="ss">:set_header</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:voice</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Webhookable</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">voice</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="ss">Twilio</span><span class="p">:</span><span class="ss">:TwiML</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>      <span class="n">r</span><span class="o">.</span><span class="n">Say</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:poem_content</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">render_twiml</span> <span class="n">response</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code makes use of the <code>set_header</code> and <code>render_twiml</code> helper methods from the Twilio Rails 4 tutorial, which we can put into a <code>Webhookable</code> module in Concerns.</p>

<figure class='code'><figcaption><span>Webhookable Concern</span><a href='https://github.com/alexpatriquin/poem-today/blob/master/app/controllers/concerns/webhookable.rb'>source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Webhookable</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_header</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;text/xml&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">render_twiml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">text</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>One way to think about this code is that we’re creating an endpoint in a special variant of XML for Twilio to come and read. We’re creating a private API for Twilio.</p>

<h3>4) Disable CSRF Protection on Twilio endpoint</h3>

<p>By default, Rails 4 blocks 3rd parties from <code>POST</code>ing, so as to prevent CSRF attacks. To accomplish this, Rails generates a random token when a form is created and then checks the token when the form is submitted. We want to accept a <code>POST</code> from Twilio, so we&rsquo;ll disable CSRF detection for the voice controller action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PoemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">skip_before_action</span> <span class="ss">:verify_authenticity_token</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:voice</span>
</span></code></pre></td></tr></table></div></figure>


<h3>5) Create a TwiML App</h3>

<p>Now that we have a permitted endpoint, we can create a new TwiML App, which is just a set of URLs that tells Twilio what to do when it receives a call via telephone or Twilio.Device.</p>

<p>Create a new TwiML App under Dev Tools in your account and enter the <code>POST</code> endpoint (ie, <code>http://poemtoday/poems/voice</code>) as the <code>Voice Request URL</code>. After saving, note your new TwiML App’s <code>SID</code>, which we’ll need to create Capability Tokens.</p>

<h3>6) Setup Capability Tokens</h3>

<p>In order to invoke Twilio.Device, users need to have a valid <a href="https://www.twilio.com/docs/client/capability-tokens">Capability Token</a>. Tokens are valid for 24 hours and it’s better for security reasons to give each of your users their own token. I actually create one on each poem page load.</p>

<p>Tokens can have Incoming or Outgoing Connection capabilities, or both. Since we want Twilio to <code>POST</code> to  our app, we’ll configure these Capability Tokens with an Outgoing Connection and pass in our TwiML App&rsquo;s <code>SID</code>, which lets Twilio know where to find our <code>voice</code> endpoint.</p>

<figure class='code'><figcaption><span>Generating Twilio Capability Tokens</span><a href='https://github.com/alexpatriquin/poem-today/blob/master/app/controllers/poems_controller.rb'>source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PoemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@poem</span> <span class="o">=</span> <span class="no">Poem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">new_twilio_token</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new_twilio_token</span>
</span><span class='line'>    <span class="n">capability</span> <span class="o">=</span> <span class="ss">Twilio</span><span class="p">:</span><span class="ss">:Util</span><span class="o">::</span><span class="no">Capability</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;TWILIO_ACCOUNT_SID&quot;</span><span class="o">]</span><span class="p">,</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;TWILIO_AUTH_TOKEN&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">capability</span><span class="o">.</span><span class="n">allow_client_outgoing</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;TWILIO_APPLICATION_SID&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@token</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">generate</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that we’re creating <code>@token</code>, an instance variable on the controller, so that we can pass it up to the view.</p>

<h3>7) Put Capability Token and text in an HTML form</h3>

<p>As we saw above in PoemsController, our Twilio Response Object accepts the text to be spoken as params, which we can send via form submission. We can use the HTML <code>data</code> attribute tag to pass the <code>@token</code> to javascript.</p>

<p><a href="http://www.poemtoday.com/poems/5706?keyword=voice"><img class="center" src="./images/post_images/voice-icon.png" width="300"></a></p>

<p>PoemToday actually uses a hidden form and the <code>volume-up</code> icon from <a href="http://fortawesome.github.io/">Font Awesome</a> for a submit button.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@poem</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;poem-content&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">content_tag</span> <span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;token&quot;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span><span class="ss">token</span><span class="p">:</span> <span class="vi">@token</span> <span class="p">}</span> <span class="k">do</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">button_tag</span> <span class="n">fa_icon</span><span class="p">(</span><span class="s2">&quot;volume-up lg&quot;</span><span class="p">),</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;keillorbot&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>8) Add Twilio.Device javascript</h3>

<p>Twilio’s TTS works through Twilio.Device, an API object. Twilio.Device serves as the main entry point for connecting with Twilio. For TTS, a connection can be understood as both a telephone and an api call. Twilio.Device connects, sends the relevant text to Twilio, holds open a port which receives an audio reading of the text, and then disconnects / hangs up.</p>

<p>Twilio.Device is only available on pages that have <a href="https://www.twilio.com/docs/client/twilio-js">twilio.js</a>. PoemToday is mostly poem pages, so I added a <code>javascript_include_tag</code> to my layout.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;%=</span> <span class="nx">javascript_include_tag</span> <span class="s2">&quot;//static.twilio.com/libs/twiliojs/1.1/twilio.min.js&quot;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we’re ready to add the javascript that will invoke Twilio.Device with the user’s token and pass the text we want read aloud (ie, <code>#poem-content</code>). The code below disables the button while the connection is active.</p>

<figure class='code'><figcaption><span>Twilio.Device Example</span><a href='https://github.com/alexpatriquin/poem-today/blob/master/app/assets/javascripts/poems.js'>source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#token&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">Twilio</span><span class="p">.</span><span class="nx">Device</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="nx">token</span><span class="p">,{</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#keillorbot&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">speak</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">speak</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">poem_content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#poem-content&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#keillorbot&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">Twilio</span><span class="p">.</span><span class="nx">Device</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span> <span class="s1">&#39;poem_content&#39;</span><span class="o">:</span><span class="nx">poem_content</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">Twilio</span><span class="p">.</span><span class="nx">Device</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#keillorbot&#39;</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a name="ngrok"></a>9) Setup ngrok to test</h3>

<p>As mentioned above, Twilio.Device only works when connected to the internet. To test, you’ll need to make localhost accessible via the internet with a utility such as ngrok. Twilio provides a good tutorial on <a href="https://www.twilio.com/blog/2013/10/test-your-webhooks-locally-with-ngrok.html">how to setup ngrok</a>.</p>

<p>Be sure to create a second TwiML App with your currently running ngrok address as your root domain. It should look something like <code>http://3eb3c9ba.ngrok.com/poems/voice</code>.</p>

<h3><a name="deploy"></a>10) Deploy</h3>

<p>That’s it! If you’ve completed all the steps above, you should be good to go with adding text-to-speech to your Rails 4 app.</p>

<p>If you run into any trouble or have any questions, feel free to ask me for help in the comments below or <a href="https://twitter.com/apatriq">message me on Twitter</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Text-To-Speech Options for Web Apps]]></title>
    <link href="http://alexpatriquin.github.io/text-to-speech-options-for-web-apps"/>
    <updated>2014-05-04T13:07:46-04:00</updated>
    <id>http://alexpatriquin.github.io/text-to-speech-options-for-web-apps</id>
    <content type="html"><![CDATA[<p>While I was building <a href="http://alexpatriquin.github.io/how-i-built-poemtoday">PoemToday</a>, I wanted to add a feature that enabled users to play any poem aloud in a robot voice. If the inspiration for PoemToday, <a href="http://writersalmanac.publicradio.org/">The Writer&rsquo;s Almanac</a>, had Garrison Keillor’s voice coming over the NPR radio waves every morning, then my app would have the voice not of a killer robot, but a Keillorbot.</p>

<p>This proved to be easier said than done. First, there was a dearth of good quality options for text-to-speech that fit right into Rails. Second, with the Twilio implementation I chose to make, there were a few configuration steps between Twilio and Rails that were neither obvious nor well documented.</p>

<p>Currently there’s a dearth of good quality text-to-speech options for web apps. I can’t really speak to mobile and desktop apps, but I believe those those platforms offer native TTS capabilities which developers can hook into.</p>

<p>Some web app options, like AT&amp;T, were paid services that seemed to actually require more of an integration hurdle and impose all kinds of usage restrictions. Others like the <a href="https://github.com/c2h2/tts">tts</a> gem relied on a Google Translate hack which limited the spoken text to only 100 characters, about a sentence. A haiku might fit under that limit, but not a medium-length or longer poem. I also reached out to <a href="https://wit.ai/">Wit.ai</a>, but they said they don’t offer TTS yet.</p>

<p>The better options were <a href="https://www.twilio.com/docs/howto/twilio-client-text-to-speech">Twilio</a> and <a href="http://tts-api.com/">tts-api.com</a>. Twilio makes text-to-speech available through Twilio.Device, an API object that effectively turns your users’ browser into a phone or “soft device”. Meanwhile tts-api.com is just a one-page website with a single textarea on a form that returns an mp3 audio file when submitted. Nice and simple!</p>

<p>Even though it was probably the best option in terms of performance, I didn’t want to download and store 6,000 mp3 files from tts-api.com, one for each poem, and rack up hosting fees. I could’ve also had the mp3 file from tts-api.com pop up in a new window, but I dislike pop ups (they’re terrible user experience) so I went with Twilio.</p>

<p>Also, while researching this post, I found the <a href="https://github.com/dejan/espeak-ruby">espeak-ruby</a> gem, which I’ll haven’t tried out&hellip; I’ll have to come back soon and post an update. In the meantime, I’m glad I got a chance to figure out the Twilio implementation as I learned a lot.</p>

<p>See the steps I took to implement <a href="http://alexpatriquin.github.io/twilio-text-to-speech-in-rails-4">Twilio text-to-speech in Rails 4</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How I Built PoemToday]]></title>
    <link href="http://alexpatriquin.github.io/how-i-built-poemtoday"/>
    <updated>2014-04-28T18:49:57-04:00</updated>
    <id>http://alexpatriquin.github.io/how-i-built-poemtoday</id>
    <content type="html"><![CDATA[<p>Today I&rsquo;m introducing <a href="http://www.poemtoday.com/">PoemToday</a>, a random poem generator that&rsquo;s powered by user behavior. Here is the story of how it works and how I made it.</p>

<p><a href="http://www.poemtoday.com/poems/3568?keyword=plato"><img class="center" src="../images/post_images/stats-poem.png" width="500"></a></p>

<p>PoemToday (also on <a href="https://github.com/alexpatriquin/poem-today">Github</a>) is a Rails web app that statistically generates a poem based on its users&#8217; profile and behavior. Each of the 6,000 poems on the site actually has a link wrapped around every word in every poem. When a user clicks one of the words, the site initiates a search of its database for the best-matching poem and redirects the user to the top result, alongside with the top image from the Flickr API for that word.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">save_top_result</span>
</span><span class='line'>  <span class="vi">@poem</span> <span class="o">=</span> <span class="vi">@results</span><span class="o">.</span><span class="n">inject</span> <span class="k">do</span> <span class="o">|</span><span class="n">winning</span><span class="p">,</span><span class="n">result</span><span class="o">|</span>
</span><span class='line'>  <span class="n">winning</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="p">?</span> <span class="n">winning</span> <span class="p">:</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_image_url</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span><span class='line'>  <span class="n">flickr</span><span class="o">.</span><span class="n">photos</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="o">=&gt;</span> <span class="s2">&quot;relevance&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Behind the scenes, PoemToday is storing information about all of the words the user has clicked and the poems the user has visited in a temporary session. When the session has enough data, it statistically generates a completely unique &ldquo;ephemeral&rdquo; poem with a statistical process known as a <a href="http://en.wikipedia.org/wiki/Markov_chain">Markov chain</a>.</p>

<!-- more -->


<h3>simplenlg vs. Markov chains</h3>

<p>Initially I tried to implement a linguistics strategy for randomly generating poems. If a user had clicked three nouns, I figured,  how difficult would it be to find a verb and then create a semi-sensical sentence? Using the Wordnik API and a ruleset I could fill in the missing parts of speech.</p>

<p>I spent a while building a Natural Language Generator without realizing that was what I was doing. Then I stumbled on simplenlg, both the <a href="https://code.google.com/p/simplenlg/">Java API</a> and the <a href="https://github.com/efi/simplenlg">ruby gem</a>, which opened up a whole new tangent of linguistic programming to me. I really love language (why else would I make a random poetry app?? ;) and this intersection of code and linguistics was an especially exciting turn in the project.</p>

<p>With user-selected keywords, simplenlg, and the Wordnik API&rsquo;s random words endpoint, which features random word generation by part of speech as well as frequency, I was able to weave together some fairly compelling random poems.</p>

<p>Then I stumbled upon Markov chains in my research, which on the first few tests in the command line quickly proved much more compelling than my patchwork NLG solution. The Markov chains were uncanny and required users click far fewer keywords to produce better sounding random poetry. It was a much lower bar to &ldquo;minimum emotional product&rdquo;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_ephemeral_poem</span>
</span><span class='line'>  <span class="vi">@poem_title</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:ephemeral_poem</span><span class="o">].</span><span class="n">values</span><span class="o">[-</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@poem_body</span> <span class="o">&lt;&lt;</span> <span class="n">markov</span><span class="o">.</span><span class="n">generate_5_sentences</span>
</span><span class='line'>  <span class="vi">@poet</span> <span class="o">=</span> <span class="s2">&quot;You&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The most fascinating aspect of Markov chains to me is that they know nothing about parts of speech or linguistics. They are just pure mathematics. And yet they sound so human.</p>

<p>I implemented the Markov chain with the <a href="https://github.com/zolrath/marky_markov">Marky Markov gem</a>, though I will do my own <a href="https://gist.github.com/alexpatriquin/11226396">implementation in ruby</a> soon.</p>

<h3>Matching Algorithm</h3>

<p>PoemToday also features a daily email option. The app will email you a poem every morning, along with information about why that poem was matched to you on that day.</p>

<p>The app connects to APIs from Twitter, The New York Times and Forecast.io for user profile data sources. The app also uses the Wordnik API to score keywords on frequency from each data source. The Wordnik API goes back to 1800, but I limited it to 2000 for contemporary word usage.</p>

<p>I treated keyword frequency like golf scores &ndash; the lower, the better, so that rare words percolate to the top of poem matches and users&#8217; inboxes. You can get a good sense of how the user-to-poem daily matching algorithm works from this Gist.</p>

<figure class='code'><figcaption><span>Keyword-Poem Match Scoring</span><a href='https://github.com/alexpatriquin/poem-today/blob/master/app/models/poem_scorer.rb'>source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">score_by_keyword_source</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">result</span><span class="o">[</span><span class="ss">:keyword_source</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:twitter</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">40</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:news</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">30</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:forecast</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">20</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">score_by_match_type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">result</span><span class="o">[</span><span class="ss">:match_type</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:occasion</span> <span class="o">||</span> <span class="ss">:subject</span> <span class="o">||</span> <span class="ss">:poet</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">100</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:title</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">50</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:first_line</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">30</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:content</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">score_by_frequency</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">#birthdays, name days and holidays have 0 freq =&gt; 100 points</span>
</span><span class='line'>    <span class="n">frequency_score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">-</span> <span class="n">result</span><span class="o">[</span><span class="ss">:keyword_frequency</span><span class="o">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">result</span><span class="o">[</span><span class="ss">:match_score</span><span class="o">]</span> <span class="o">+=</span> <span class="n">frequency_score</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also used a Postgres search gem, pg_search, to quickly search through all of the poems and their content. This was a lightweight option versus implementing a platform such as Solr or EC2.</p>

<p>Finally, I used <a href="http://localhost:4000/twilio-text-to-speech-in-rails-4">Twilio&rsquo;s text-to-speech</a> feature to read the poems in a fun robot voice. This was actually one of harder parts of the project as it required that I create a virtual <a href="http://localhost:4000/twilio-text-to-speech-in-rails-4">Twilio device</a> with Javascript on each poem page load and could only test it in production or with ultra-slow ngrok, which exposed my local web server to the internet.</p>

<p>PoemToday was one of my most technically ambitions project to date. Judging from the fascinated reactions of a few dozen beta users, I&rsquo;d say PoemToday is on a path to success and I look forward to continuing to build it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introducing Tender]]></title>
    <link href="http://alexpatriquin.github.io/introducing-tender"/>
    <updated>2014-04-27T17:49:57-04:00</updated>
    <id>http://alexpatriquin.github.io/introducing-tender</id>
    <content type="html"><![CDATA[<p><a href="http://www.tendermessenger.com/">Tender</a> is a social payments app (think <a href="https://venmo.com/">Venmo</a>) for Bitcoin. Users can send or receive any amount of Bitcoin, including extremely small amounts which can be used to validated the identity of counter-parties.</p>

<p><a href="http://www.tendermessenger.com/"><img class="center" src="../images/post_images/tender-screenshot.png" width="500"></a></p>

<p>I built Tender (also on <a href="https://github.com/alexpatriquin/BitcoinMessenger">Github</a>) with <a href="https://twitter.com/CKohlbrenner">Chris Kohlbrenner</a>. I came up with the initial idea for the project as a Bitcoin dating site&hellip; hence the triple-play on words with the name &ldquo;Tender&rdquo;. However, Chris and I decided to generalize the app and make it usable (or at least instructive) for other open source projects as a general social messaging utility.</p>

<h3>Why Bitcoin Messaging?</h3>

<p>Bitcoin gets a lot of hype these days, but after working with the cryptocurrency a bit, I really do see its potential to transform online payments and much more. For example, a messaging system can require a very small amount of Bitcoin get sent with each message as a way to prevent or at least deter bulk volume spammers. After practicing our web development skills, our main purpose in building Tender was to demonstrate this anti-spam concept.</p>

<p>We used Ruby on Rails as the framework and built the Bitcoin transactions features with the Coinbase API and the messaging functionality with a gem called Mailboxer. In the process of weaving those two features together, we learned a lot about them. Payments and messaging share the concept of &ldquo;credits&rdquo; and &ldquo;debits&rdquo; to a balance or mailbox. Kind of like double-ledger accounting, we had to do a credit and a debit whenever a user sent money and a message to another user, and vice-versa. You can see that code play out in code below.</p>

<figure class='code'><figcaption><span>Tender Send-Request Bitcoin</span><a href='https://github.com/alexpatriquin/BitcoinMessenger/blob/master/app/controllers/conversations_controller.rb'>source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">send_message_and_bitcoin</span>
</span><span class='line'>  <span class="n">current_user</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="vi">@recipient</span><span class="p">,</span> <span class="vi">@message</span><span class="p">,</span> <span class="s1">&#39;You\&#39;ve got Bitcoin.&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">current_user</span><span class="o">.</span><span class="n">send_bitcoin</span><span class="p">(</span><span class="vi">@recipient</span><span class="p">,</span> <span class="vi">@amount</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@message</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="vi">@amount</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:send_or_request</span><span class="o">]</span><span class="p">,</span> <span class="vi">@recipient</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="n">redirect_to</span> <span class="vi">@current_page</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">&quot;Sent </span><span class="si">#{</span><span class="vi">@amount</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="vi">@recipient</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'>  <span class="n">debit_balance</span><span class="p">(</span><span class="vi">@amount</span><span class="p">)</span>
</span><span class='line'>  <span class="n">credit_balance</span><span class="p">(</span><span class="vi">@recipient</span><span class="p">,</span> <span class="vi">@amount</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">send_message_and_request_bitcoin</span>
</span><span class='line'>  <span class="n">current_user</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="vi">@recipient</span><span class="p">,</span> <span class="vi">@message</span><span class="p">,</span> <span class="s1">&#39;You\&#39;ve got Bitcoin.&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">current_user</span><span class="o">.</span><span class="n">request_bitcoin</span><span class="p">(</span><span class="vi">@recipient</span><span class="p">,</span> <span class="vi">@amount</span><span class="p">,</span> <span class="vi">@message</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@message</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="vi">@amount</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:send_or_request</span><span class="o">]</span><span class="p">,</span> <span class="vi">@recipient</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="n">redirect_to</span> <span class="vi">@current_page</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">&quot;Sent request for </span><span class="si">#{</span><span class="vi">@amount</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="vi">@recipient</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Coinbase and Typeahead.js</h3>

<p>To build Tender, we used Devise and Omniauth to authenticate users, enable them to sign in via Coinbase and to validate their balances on Coinbase. The app features a lot of validations and notices to users to confirm that their transactions go through when they should and shows descriptive alerts when they shouldn&rsquo;t, such as when the user has insufficient Bitcoin balance.</p>

<p>We also made it easy for users to find each other by implementing an autosuggest user search feature with Twitter&rsquo;s Typeahead.js, and brought the user objects to the views with the gon gem. Finally, Tender features a robust testing suite with Rspec and Capybara, at 92% code coverage.</p>

<p>This was a very interesting project on many levels, from working with a new payment type like Bitcoin, to getting deep into the mechanics of messaging. I also learned quite a bit about implementing complex Javascript features in Rails.</p>
]]></content>
  </entry>
  
</feed>
